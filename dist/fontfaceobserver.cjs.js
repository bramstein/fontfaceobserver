"use strict";var classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),interopRequireDefault=function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});var _Ruler=require("./Ruler.js"),_Ruler2=interopRequireDefault(_Ruler),_dom=require("./dom.js"),FontFaceObserver=function(){function h(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return classCallCheck(this,h),this.family=e,this.style=t.style||"normal",this.weight=t.weight||"normal",this.stretch=t.stretch||"normal",this}return createClass(h,null,[{key:"getUserAgent",value:function(){return window.navigator.userAgent}},{key:"getNavigatorVendor",value:function(){return window.navigator.vendor}},{key:"hasWebKitFallbackBug",value:function(){if(null===h.HAS_WEBKIT_FALLBACK_BUG){var e=/AppleWebKit\/([0-9]+)(?:\.([0-9]+))/.exec(h.getUserAgent());h.HAS_WEBKIT_FALLBACK_BUG=!!e&&(parseInt(e[1],10)<536||536===parseInt(e[1],10)&&parseInt(e[2],10)<=11)}return h.HAS_WEBKIT_FALLBACK_BUG}},{key:"hasSafari10Bug",value:function(){if(null===h.HAS_SAFARI_10_BUG)if(h.supportsNativeFontLoading()&&/Apple/.test(h.getNavigatorVendor())){var e=/AppleWebKit\/([0-9]+)(?:\.([0-9]+))(?:\.([0-9]+))/.exec(h.getUserAgent());h.HAS_SAFARI_10_BUG=!!e&&parseInt(e[1],10)<603}else h.HAS_SAFARI_10_BUG=!1;return h.HAS_SAFARI_10_BUG}},{key:"supportsNativeFontLoading",value:function(){return null===h.SUPPORTS_NATIVE_FONT_LOADING&&(h.SUPPORTS_NATIVE_FONT_LOADING=!!document.fonts),h.SUPPORTS_NATIVE_FONT_LOADING}},{key:"supportStretch",value:function(){if(null===h.SUPPORTS_STRETCH){var e=document.createElement("div");try{e.style.font="condensed 100px sans-serif"}catch(e){}h.SUPPORTS_STRETCH=""!==e.style.font}return h.SUPPORTS_STRETCH}}]),createClass(h,[{key:"load",value:function(e,t){var g=this,S=e||"BESbswy",v=0,T=t||h.DEFAULT_TIMEOUT,A=g.getTime();return new Promise(function(_,d){if(h.supportsNativeFontLoading()&&!h.hasSafari10Bug()){var e=new Promise(function(n,r){!function t(){var e=g.getTime();T<=e-A?r():document.fonts.load(g.getStyle('"'+g.family+'"'),S).then(function(e){1<=e.length?n():setTimeout(t,25)},function(){r()})}()}),t=new Promise(function(e,t){v=setTimeout(t,T)});Promise.race([t,e]).then(function(){clearTimeout(v),_(g)},function(){d(g)})}else(0,_dom.onReady)(function(){var r=new _Ruler2.default(S),i=new _Ruler2.default(S),o=new _Ruler2.default(S),a=-1,u=-1,l=-1,e=-1,t=-1,n=-1,s=document.createElement("div");function c(){null!==s.parentNode&&s.parentNode.removeChild(s)}function f(){if((-1!=a&&-1!=u||-1!=a&&-1!=l||-1!=u&&-1!=l)&&(a==u||a==l||u==l)){if(h.hasWebKitFallbackBug()&&(a==e&&u==e&&l==e||a==t&&u==t&&l==t||a==n&&u==n&&l==n))return;c(),clearTimeout(v),_(g)}}s.dir="ltr",r.setFont(g.getStyle("sans-serif")),i.setFont(g.getStyle("serif")),o.setFont(g.getStyle("monospace")),s.appendChild(r.getElement()),s.appendChild(i.getElement()),s.appendChild(o.getElement()),document.body.appendChild(s),e=r.getWidth(),t=i.getWidth(),n=o.getWidth(),function e(){var t=g.getTime();if(T<=t-A)c(),d(g);else{var n=document.hidden;!0!==n&&void 0!==n||(a=r.getWidth(),u=i.getWidth(),l=o.getWidth(),f()),v=setTimeout(e,50)}}(),r.onResize(function(e){a=e,f()}),r.setFont(g.getStyle('"'+g.family+'",sans-serif')),i.onResize(function(e){u=e,f()}),i.setFont(g.getStyle('"'+g.family+'",serif')),o.onResize(function(e){l=e,f()}),o.setFont(g.getStyle('"'+g.family+'",monospace'))})})}},{key:"getStyle",value:function(e){return[this.style,this.weight,h.supportStretch()?this.stretch:"","100px",e].join(" ")}},{key:"getTime",value:function(){return(new Date).getTime()}}]),h}();FontFaceObserver.Ruler=_Ruler2.default,FontFaceObserver.HAS_WEBKIT_FALLBACK_BUG=null,FontFaceObserver.HAS_SAFARI_10_BUG=null,FontFaceObserver.SUPPORTS_STRETCH=null,FontFaceObserver.SUPPORTS_NATIVE_FONT_LOADING=null,FontFaceObserver.DEFAULT_TIMEOUT=3e3,exports.default=FontFaceObserver;
